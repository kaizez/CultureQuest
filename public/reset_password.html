<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - CultureQuest</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='reset-password.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Security Indicator -->
    <div class="security-indicator" id="security-indicator">
        üîí Secure Connection
    </div>

    <!-- Animated Background -->
    <div class="bg-container">
        <div class="gradient-bg"></div>
        <div class="floating-orbs">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            <div class="orb orb-3"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="signup-card">
            <div class="card-header">
                <h2>üîê Reset Your Password</h2>
                <p>Create a new secure password for <strong>{{ email }}</strong></p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">
                                {% if category == 'success' %}
                                    <span class="flash-icon">‚úÖ</span>
                                {% elif category == 'error' or category == 'danger' %}
                                    <span class="flash-icon">‚ùå</span>
                                {% else %}
                                    <span class="flash-icon">‚ÑπÔ∏è</span>
                                {% endif %}
                                <span class="flash-text">{{ message|e }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Reset Password Form -->
            <form method="POST" action="{{ url_for('login.reset_password') }}" class="signup-form" id="resetForm">
                <div class="input-group">
                    <label for="password" class="input-label">New Password</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="Create a strong password" 
                            required 
                            minlength="8"
                            maxlength="128"
                            aria-describedby="password-help password-strength"
                            autocomplete="new-password"
                            data-validate="password"
                        />
                        <button 
                            type="button" 
                            class="toggle-password" 
                            onclick="togglePassword('password')"
                            aria-label="Show password"
                            tabindex="-1"
                        >
                            <span aria-hidden="true">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div class="password-strength" id="password-strength">
                        <div class="strength-meter">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text">
                            <span id="strength-label">Password strength</span>
                            <span id="strength-score"></span>
                        </div>
                        <ul class="strength-requirements">
                            <li id="req-length">At least 8 characters</li>
                            <li id="req-uppercase">One uppercase letter</li>
                            <li id="req-lowercase">One lowercase letter</li>
                            <li id="req-number">One number</li>
                            <li id="req-special">One special character</li>
                        </ul>
                    </div>
                </div>

                <div class="input-group">
                    <label for="confirm_password" class="input-label">Confirm New Password</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="confirm_password" 
                            name="confirm_password" 
                            placeholder="Confirm your password" 
                            required 
                            minlength="8"
                            maxlength="128"
                            aria-describedby="confirm-password-help"
                            autocomplete="new-password"
                            data-validate="confirm-password"
                        />
                        <button 
                            type="button" 
                            class="toggle-password" 
                            onclick="togglePassword('confirm_password')"
                            aria-label="Show confirm password"
                            tabindex="-1"
                        >
                            <span aria-hidden="true">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div id="confirm-password-help" class="password-match">Re-enter your password to confirm</div>
                </div>

                <button type="submit" class="signup-btn-primary" id="resetBtn">
                    <span class="btn-text">Reset Password</span>
                    <span class="btn-loader" aria-hidden="true" style="display: none;"></span>
                </button>
            </form>

            <!-- Security Tips -->
            <div class="security-tips">
                <h4>üõ°Ô∏è Password Security Tips</h4>
                <ul>
                    <li>Use a mix of uppercase, lowercase, numbers, and symbols</li>
                    <li>Avoid common words, personal information, or patterns</li>
                    <li>Make it at least 8 characters long (longer is better)</li>
                    <li>Don't reuse passwords from other accounts</li>
                    <li>Consider using a password manager</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Common passwords list (subset for demo)
        const COMMON_PASSWORDS = new Set([
            'password', '123456', 'password123', 'admin', 'qwerty', 
            'letmein', 'welcome', 'monkey', '1234567890', 'password1',
            'abc123', 'Password1', 'password!', '12345678', 'sunshine'
        ]);

        // Password visibility toggle
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            const button = field.parentNode.querySelector('.toggle-password');
            if (!button) return;
            
            const eyeIcon = button.querySelector('span[aria-hidden="true"]');
            if (!eyeIcon) return;
            
            if (field.type === 'password') {
                field.type = 'text';
                eyeIcon.textContent = 'üôà';
                button.setAttribute('aria-label', 'Hide password');
            } else {
                field.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
                button.setAttribute('aria-label', 'Show password');
            }
        }

        // Password strength calculation
        function calculatePasswordStrength(password) {
            let score = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            // Update requirement indicators
            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(`req-${req}`);
                if (element) {
                    const wasValid = element.classList.contains('valid');
                    const isValid = requirements[req];
                    
                    if (isValid && !wasValid) {
                        element.classList.add('valid');
                        element.style.animation = 'checkmarkBounce 0.5s ease';
                        setTimeout(() => {
                            element.style.animation = '';
                        }, 500);
                    } else if (!isValid && wasValid) {
                        element.classList.remove('valid');
                    }
                }
            });

            // Calculate score
            Object.keys(requirements).forEach(req => {
                if (requirements[req]) score += 1;
            });

            // Bonus points
            if (password.length >= 12) score += 1;
            if (password.length >= 16) score += 1;

            // Penalty for common passwords
            if (COMMON_PASSWORDS.has(password.toLowerCase())) score -= 2;

            return { score: Math.max(0, score), requirements };
        }

        function updatePasswordStrength(password) {
            const { score } = calculatePasswordStrength(password);
            const strengthMeter = document.querySelector('.strength-meter');
            const strengthFill = document.querySelector('.strength-fill');
            const strengthLabel = document.getElementById('strength-label');
            const strengthScore = document.getElementById('strength-score');

            if (!strengthMeter || !strengthFill || !strengthLabel || !strengthScore) return;

            strengthMeter.classList.remove('weak', 'fair', 'good', 'strong', 'very-strong');

            if (password.length === 0) {
                strengthLabel.textContent = 'Password strength';
                strengthScore.textContent = '';
                return;
            }

            const levels = [
                { min: 0, max: 2, class: 'weak', label: 'Weak' },
                { min: 3, max: 4, class: 'fair', label: 'Fair' },
                { min: 5, max: 6, class: 'good', label: 'Good' },
                { min: 7, max: 8, class: 'strong', label: 'Strong' }
            ];

            const level = levels.find(l => score >= l.min && score <= l.max) || levels[0];
            
            strengthMeter.classList.add(level.class);
            strengthLabel.textContent = 'Password strength:';
            strengthScore.textContent = level.label;
        }

        // Password confirmation check
        function checkPasswordMatch() {
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirm_password');
            const matchIndicator = document.getElementById('confirm-password-help');

            if (!password || !confirmPassword || !matchIndicator) return;

            matchIndicator.classList.remove('match', 'no-match');

            if (confirmPassword.value.length === 0) {
                matchIndicator.textContent = 'Re-enter your password to confirm';
                return;
            }

            if (password.value === confirmPassword.value) {
                matchIndicator.classList.add('match');
                matchIndicator.textContent = 'Passwords match ‚úì';
            } else {
                matchIndicator.classList.add('no-match');
                matchIndicator.textContent = 'Passwords do not match ‚úó';
            }
        }

        // Initialize password monitoring
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('password');
            const confirmPasswordField = document.getElementById('confirm_password');

            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    updatePasswordStrength(this.value);
                    checkPasswordMatch();
                });
            }

            if (confirmPasswordField) {
                confirmPasswordField.addEventListener('input', checkPasswordMatch);
            }

            // Auto-focus password field
            passwordField.focus();
        });

        // Form submission handling
        document.getElementById('resetForm').addEventListener('submit', function(e) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (password !== confirmPassword) {
                e.preventDefault();
                showMessage('Passwords do not match', 'error');
                return;
            }

            if (password.length < 8) {
                e.preventDefault();
                showMessage('Password must be at least 8 characters long', 'error');
                return;
            }

            // Show loading state
            const resetBtn = document.getElementById('resetBtn');
            const btnText = resetBtn.querySelector('.btn-text');
            const btnLoader = resetBtn.querySelector('.btn-loader');

            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            resetBtn.disabled = true;
        });

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flash-message ${type}`;
            messageDiv.innerHTML = `
                <span class="flash-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span class="flash-text">${message}</span>
            `;

            const card = document.querySelector('.signup-card');
            const header = document.querySelector('.card-header');
            card.insertBefore(messageDiv, header.nextSibling);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Clear flash messages after 10 seconds
        setTimeout(() => {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(msg => msg.remove());
        }, 10000);
    </script>

    <style>
        /* Additional styles for reset password page */
        .password-match.match {
            color: #48bb78;
            font-weight: 500;
        }

        .password-match.no-match {
            color: #f56565;
            font-weight: 500;
        }

        .security-tips {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .security-tips h4 {
            color: #4a90e2;
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .security-tips ul {
            color: var(--text-white);
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
            font-size: 13px;
        }

        .security-tips li {
            margin-bottom: 4px;
        }

        .flash-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .flash-message.success {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid rgba(72, 187, 120, 0.3);
            color: #48bb78;
        }

        .flash-message.error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            color: #f56565;
        }

        .flash-icon {
            font-size: 18px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes checkmarkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .security-tips {
                padding: 16px;
            }

            .security-tips h4 {
                font-size: 14px;
            }

            .security-tips ul {
                font-size: 12px;
                padding-left: 16px;
            }
        }
    </style>
</body>
</html>