{% extends "base.html" %}

{% block title %}Rewards Redemption{% endblock %}

{% block extra_css %}
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    line-height: 1.6;
    margin: 0;
    padding: 0;
}

.main-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
}

.page-header {
    text-align: center;
    margin-bottom: 48px;
}

.page-title {
    font-size: 48px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1.1;
    margin-bottom: 16px;
    letter-spacing: -0.02em;
}

.points-display {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 24px;
    padding: 16px 24px;
    color: white;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 32px;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.points-icon {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.rewards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 48px;
}

.reward-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
}

.reward-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
}

.reward-image {
    width: 100%;
    height: 200px;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.reward-content {
    padding: 24px;
}

.reward-name {
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.reward-description {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
    line-height: 1.5;
}

.reward-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.reward-cost {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.cost-icon {
    color: #6366f1;
}

.reward-stock {
    font-size: 12px;
    color: #6b7280;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 12px;
}

.stock-low {
    background: #fef2f2;
    color: #dc2626;
}

.stock-out {
    background: #f3f4f6;
    color: #9ca3af;
}

.redeem-button {
    width: 100%;
    background: #6366f1;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.redeem-button:hover:not(:disabled) {
    background: #5856eb;
    transform: translateY(-1px);
}

.redeem-button:disabled {
    background: #d1d5db;
    color: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.insufficient-points {
    background: #fbbf24;
    color: #92400e;
}

.insufficient-points:hover {
    background: #f59e0b;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #6b7280;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: color 0.2s ease;
    margin-bottom: 24px;
}

.back-link:hover {
    color: #1f2937;
}

.username-display {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #f0f9ff;
    border: 1px solid #e0f2fe;
    border-radius: 24px;
    padding: 8px 16px;
    color: #0369a1;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 16px;
}

.username-icon {
    width: 20px;
    height: 20px;
    background: #0369a1;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 700;
}


/* Flash Messages */
.flash-message {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
}

.flash-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #166534;
}

.flash-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
}

.modal-content {
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    margin: auto;
    box-sizing: border-box;
}

.modal-header {
    padding: 20px 20px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: #1f2937;
    word-wrap: break-word;
    flex: 1;
    margin-right: 10px;
}

.close {
    font-size: 24px;
    font-weight: bold;
    color: #6b7280;
    cursor: pointer;
    line-height: 1;
    flex-shrink: 0;
}

.close:hover {
    color: #1f2937;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #1f2937;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Google Places Autocomplete styling */
.pac-container {
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid #d1d5db;
    font-size: 14px;
}

.pac-item {
    padding: 8px 12px;
    border-bottom: 1px solid #f3f4f6;
}

.pac-item:hover {
    background-color: #f9fafb;
}

.pac-item-selected {
    background-color: #6366f1;
    color: white;
}

.location-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.location-btn:hover {
    background: #e5e7eb;
}

.help-text {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: #6b7280;
}

.modal-footer {
    padding: 16px 20px 20px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.btn-cancel {
    padding: 10px 20px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.btn-cancel:hover {
    background: #e5e7eb;
}

.btn-claim {
    padding: 10px 20px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-claim:hover {
    background: #5856eb;
}

.btn-claim:disabled {
    background: #d1d5db;
    cursor: not-allowed;
}

/* History Section Styles */
.history-section {
    margin: 48px 0;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.history-title {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    padding: 32px 32px 24px;
    border-bottom: 1px solid #e5e7eb;
}

.history-tabs {
    display: flex;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.tab-button {
    flex: 1;
    padding: 16px 24px;
    background: none;
    border: none;
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
}

.tab-button.active {
    color: #6366f1;
    background: white;
    border-bottom-color: #6366f1;
}

.tab-button:hover:not(.active) {
    color: #1f2937;
    background: #f3f4f6;
}

.history-tab {
    display: none;
    padding: 0;
}

.history-tab.active {
    display: block;
}

.history-table-container {
    overflow-x: auto;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.history-table th {
    background: #f9fafb;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
}

.history-table td {
    padding: 16px 12px;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: top;
}

.history-table tbody tr:hover {
    background: #f9fafb;
}

.order-id {
    background: #f3f4f6;
    color: #6b7280;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Monaco', 'Consolas', monospace;
}

.reward-info strong {
    display: block;
    color: #1f2937;
    margin-bottom: 2px;
}

.reward-info small {
    color: #6b7280;
    font-size: 12px;
    line-height: 1.3;
}

.collection-date {
    font-weight: 500;
    color: #1f2937;
}

.collection-point-info strong {
    display: block;
    color: #1f2937;
    margin-bottom: 2px;
}

.collection-point-info small {
    color: #059669;
    font-size: 12px;
    font-weight: 500;
}

/* Legacy support for carpark-info class */
.carpark-info strong {
    display: block;
    color: #1f2937;
    margin-bottom: 2px;
}

.carpark-info small {
    color: #059669;
    font-size: 12px;
    font-weight: 500;
}

.no-location {
    color: #9ca3af;
    font-style: italic;
    font-size: 13px;
}

.points-spent {
    color: #6366f1;
    font-weight: 600;
    background: #f0f9ff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.claim-date {
    font-weight: 500;
    color: #1f2937;
    display: block;
    margin-bottom: 2px;
}

.claim-date + small {
    color: #6b7280;
    font-size: 11px;
}

.redeem-date {
    color: #1f2937;
    font-weight: 500;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-view,
.btn-directions,
.btn-refund {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.btn-view {
    background: #f0f9ff;
    color: #1e40af;
}

.btn-view:hover {
    background: #dbeafe;
    transform: translateY(-1px);
}

.btn-directions {
    background: #f0fdf4;
    color: #166534;
}

.btn-directions:hover {
    background: #dcfce7;
    transform: translateY(-1px);
}

.btn-refund {
    background: #fef2f2;
    color: #dc2626;
}

.btn-refund:hover {
    background: #fecaca;
    transform: translateY(-1px);
}

.btn-refund:disabled {
    background: #f3f4f6;
    color: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.no-history {
    text-align: center;
    padding: 80px 32px;
    color: #6b7280;
}

.no-history-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.no-history h3 {
    font-size: 20px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 8px;
}

.no-history p {
    font-size: 14px;
    margin: 0;
    line-height: 1.5;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .main-content {
        padding: 24px 16px;
    }

    .page-title {
        font-size: 36px;
    }

    .rewards-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .reward-card {
        margin-bottom: 16px;
    }

    .modal {
        padding: 10px;
    }

    .modal-content {
        width: 100%;
        max-height: 95vh;
        margin: 0;
    }

    .modal-header {
        padding: 16px 16px 12px;
    }

    .modal-header h2 {
        font-size: 18px;
    }

    .modal-body {
        padding: 16px;
        max-height: 50vh;
    }

    .modal-footer {
        padding: 12px 16px 16px;
        gap: 8px;
    }

    .btn-cancel,
    .btn-claim {
        padding: 8px 16px;
        font-size: 14px;
        flex: 1;
        min-width: 80px;
    }

    .history-title {
        font-size: 24px;
        padding: 24px 16px 16px;
    }

    .history-table-container {
        overflow-x: scroll;
    }

    .history-table {
        min-width: 800px;
    }

    .history-table th,
    .history-table td {
        padding: 12px 8px;
        font-size: 13px;
    }

    .no-history {
        padding: 60px 16px;
    }

    .tab-button {
        padding: 12px 16px;
        font-size: 13px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="main-content">

    <div class="page-header">
        <h1 class="page-title">Redeem Your Rewards</h1>
        <div class="username-display">
            <div class="username-icon">{{ username[0].upper() }}</div>
            <span>Welcome, {{ username }}</span>
        </div>
        <div class="points-display" id="user-points">
            <div class="points-icon">üíé</div>
            <span>You have <strong>{{ user_points }}</strong> points</span>
        </div>
    </div>

    <div id="flash-messages"></div>

    <div class="rewards-grid">
        {% for item in reward_items %}
        <div class="reward-card">
            <div class="reward-image" {% if item.image_url %}style="background-image: url('{{ item.image_url }}')"{% endif %}>
                {% if not item.image_url %}
                    {% if item.name == '$1 Voucher' %}üé´
                    {% elif 'Bag' in item.name %}üëú
                    {% elif 'Plush' in item.name %}üß∏
                    {% elif 'Keychain' in item.name %}üîë
                    {% elif 'Tree' in item.name %}üå±
                    {% else %}üéÅ{% endif %}
                {% endif %}
            </div>
            <div class="reward-content">
                <h3 class="reward-name">{{ item.name }}</h3>
                <p class="reward-description">{{ item.description or 'A wonderful reward item' }}</p>
                
                <div class="reward-footer">
                    <div class="reward-cost">
                        <span class="cost-icon">üíé</span>
                        <span>{{ item.cost }} Points</span>
                    </div>
                    <div class="reward-stock {% if item.stock == 0 %}stock-out{% elif item.stock < 10 %}stock-low{% endif %}">
                        Stock: {{ item.stock }}
                    </div>
                </div>
                
                <button class="redeem-button" 
                        onclick="openClaimModal({{ item.id }}, '{{ item.name }}', {{ item.cost }})"
                        {% if item.stock == 0 %}disabled{% endif %}
                        {% if user_points < item.cost and item.stock > 0 %}disabled class="redeem-button insufficient-points"{% endif %}>
                    {% if item.stock == 0 %}
                        Out of Stock
                    {% elif user_points < item.cost %}
                        Need {{ item.cost - user_points }} more points
                    {% else %}
                        Claim Reward
                    {% endif %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Rewards History Section -->
    {% if user_reward_orders or user_redemptions %}
    <div class="history-section">
        <h2 class="history-title">Your Rewards History</h2>
        <div class="history-tabs">
            <button class="tab-button active" onclick="showHistoryTab('claimed')">Claimed Rewards</button>
            {% if user_redemptions %}
            <button class="tab-button" onclick="showHistoryTab('redeemed')">Previous Redemptions</button>
            {% endif %}
        </div>
        
        <!-- Claimed Rewards Tab -->
        <div id="claimed-tab" class="history-tab active">
            {% if user_reward_orders %}
            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Reward</th>
                            <th>Collection Date</th>
                            <th>Collection Location</th>
                            <th>Points</th>
                            <th>Status</th>
                            <th>Claimed On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in user_reward_orders %}
                        <tr>
                            <td>
                                <code class="order-id">{{ order.order_id[:8] }}...</code>
                            </td>
                            <td>
                                <div class="reward-info">
                                    <strong>{{ order.reward_item.name if order.reward_item else 'Unknown Item' }}</strong>
                                    {% if order.reward_item and order.reward_item.description %}
                                    <small>{{ order.reward_item.description[:50] }}{% if order.reward_item.description|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="collection-date">{{ order.collection_date.strftime('%b %d, %Y') }}</span>
                            </td>
                            <td>
                                {% if order.assigned_carpark_name %}
                                <div class="collection-point-info">
                                    <strong>{{ order.assigned_carpark_name[:25] }}{% if order.assigned_carpark_name|length > 25 %}...{% endif %}</strong>
                                    {% if order.carpark_distance %}
                                    <small>{{ "%.1f"|format(order.carpark_distance) }} km away</small>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="no-location">Collection point pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="points-spent">{{ order.points_spent }} pts</span>
                            </td>
                            <td>
                                <span class="status-badge status-{{ order.status }}">{{ order.status.title() }}</span>
                            </td>
                            <td>
                                <span class="claim-date">{{ order.created_at.strftime('%b %d, %Y') }}</span>
                                <small>{{ order.created_at.strftime('%H:%M') }}</small>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="/rewards/confirmation/{{ order.order_id }}" class="btn-view" title="View Details">üìã</a>
                                    {% if order.assigned_carpark_latitude and order.assigned_carpark_longitude %}
                                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ order.assigned_carpark_latitude }},{{ order.assigned_carpark_longitude }}" 
                                       target="_blank" class="btn-directions" title="Get Directions">üìç</a>
                                    {% endif %}
                                    {% if order.status == 'pending' %}
                                    <button class="btn-refund" onclick="refundOrder('{{ order.order_id }}', '{{ order.reward_item.name if order.reward_item else 'Unknown Item' }}', {{ order.points_spent }})" title="Refund Order">‚Ü©Ô∏è</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-history">
                <div class="no-history-icon">üéÅ</div>
                <h3>No Claimed Rewards Yet</h3>
                <p>When you claim rewards, they'll appear here with collection details and locations.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Previous Redemptions Tab (Legacy) -->
        {% if user_redemptions %}
        <div id="redeemed-tab" class="history-tab">
            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Reward</th>
                            <th>Points Spent</th>
                            <th>Status</th>
                            <th>Redeemed On</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for redemption in user_redemptions %}
                        <tr>
                            <td>
                                <strong>{{ redemption.reward_item.name if redemption.reward_item else 'Unknown Item' }}</strong>
                            </td>
                            <td>
                                <span class="points-spent">{{ redemption.points_spent }} pts</span>
                            </td>
                            <td>
                                <span class="status-badge status-{{ redemption.status }}">{{ redemption.status.title() }}</span>
                            </td>
                            <td>
                                <span class="redeem-date">{{ redemption.redeemed_at.strftime('%b %d, %Y %H:%M') }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="no-history">
        <div class="no-history-icon">üéÅ</div>
        <h3>No Rewards History</h3>
        <p>Start claiming rewards to see your history here!</p>
    </div>
    {% endif %}
    
</div>

<!-- Custom Alert Modal -->
<div id="customAlert" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2 id="alertTitle">Notice</h2>
            <span class="close" onclick="closeCustomAlert()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="alertMessage" style="white-space: pre-wrap; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; max-height: 300px; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-claim" onclick="closeCustomAlert()">OK</button>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirm" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 id="confirmTitle">Confirm Action</h2>
            <span class="close" onclick="closeCustomConfirm(false)">&times;</span>
        </div>
        <div class="modal-body">
            <div id="confirmMessage" style="white-space: pre-wrap; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; max-height: 300px; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeCustomConfirm(false)">Cancel</button>
            <button type="button" class="btn-claim" onclick="closeCustomConfirm(true)">Confirm</button>
        </div>
    </div>
</div>

<!-- Claim Reward Modal -->
<div id="claimModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Claim Reward</h2>
            <span class="close" onclick="closeClaimModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="claimForm">
                <div class="form-group">
                    <label for="collectionDate">Select Collection Date:</label>
                    <input type="date" id="collectionDate" name="collection_date" required>
                </div>
                
                <div class="form-group">
                    <label for="customerAddress">Your Address:</label>
                    <input type="text" id="customerAddress" name="address" placeholder="Start typing your address..." required autocomplete="off">
                    <small class="help-text">Start typing to see address suggestions from Google Places. We'll assign the nearest polytechnic collection point.</small>
                </div>
                
                <div class="form-group">
                    <button type="button" id="useCurrentLocation" class="location-btn">üìç Use Current Location</button>
                    <small class="help-text">Click to automatically detect your location for nearest collection point assignment</small>
                </div>
                
                <div id="mapContainer">
                    <div id="claimMap" style="height: 250px; width: 100%; margin: 10px 0; border-radius: 8px;"></div>
                    <small class="help-text">üìç Map shows your selected location</small>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeClaimModal()">Cancel</button>
                    <button type="submit" class="btn-claim" id="submitClaim">Claim Reward</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% if google_maps_api_key and google_maps_api_key != 'YOUR_GOOGLE_MAPS_API_KEY_HERE' %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
{% endif %}
<script>
let currentPoints = {{ user_points }};
let confirmCallback = null;

// Custom Alert Function
function customAlert(message, title = 'Notice') {
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertMessage').innerHTML = message.replace(/\n/g, '<br>');
    document.getElementById('customAlert').style.display = 'flex';
}

function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
}

// Custom Confirm Function
function customConfirm(message, title = 'Confirm Action') {
    return new Promise((resolve) => {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
        document.getElementById('customConfirm').style.display = 'flex';
        
        confirmCallback = resolve;
    });
}

function closeCustomConfirm(result) {
    document.getElementById('customConfirm').style.display = 'none';
    if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
    }
}

// Close modals when clicking outside
document.getElementById('customAlert').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCustomAlert();
    }
});

document.getElementById('customConfirm').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCustomConfirm(false);
    }
});

function showNotification(message, type) {
    // Remove existing notifications
    $('.notification').remove();
    
    const notification = $('<div>').addClass('notification').addClass(type).text(message);
    
    // Style the notification
    notification.css({
        'position': 'fixed',
        'top': '20px',
        'right': '20px',
        'padding': '12px 20px',
        'border-radius': '8px',
        'color': 'white',
        'font-weight': 'bold',
        'z-index': '9999',
        'max-width': '300px',
        'word-wrap': 'break-word'
    });
    
    if (type === 'success') {
        notification.css('background-color', '#6366f1');
    } else if (type === 'error') {
        notification.css('background-color', '#dc3545');
    } else if (type === 'warning') {
        notification.css('background-color', '#ffc107');
        notification.css('color', '#212529');
    }
    
    $('body').append(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(function() {
        notification.fadeOut(500, function() {
            notification.remove();
        });
    }, 5000);
}

function redeemReward(rewardId, rewardName, cost) {
    if (currentPoints < cost) {
        showNotification('Insufficient points to redeem this reward', 'error');
        return;
    }
    
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Redeeming...';
    
    fetch('/rewards/redeem', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: '{{ username }}',
            reward_id: rewardId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Update points display
            currentPoints = data.remaining_points;
            document.getElementById('user-points').innerHTML = `
                <div class="points-icon">üíé</div>
                <span>You have <strong>${currentPoints}</strong> points</span>
            `;
            
            // Update stock display
            const card = button.closest('.reward-card');
            const stockElement = card.querySelector('.reward-stock');
            stockElement.textContent = `Stock: ${data.remaining_stock}`;
            
            // Update button states for all cards
            updateAllButtonStates();
            
            // If this item is now out of stock, disable its button
            if (data.remaining_stock === 0) {
                button.textContent = 'Out of Stock';
                button.disabled = true;
                stockElement.classList.add('stock-out');
            } else {
                button.textContent = 'Redeem';
                button.disabled = false;
            }
        } else {
            showNotification(data.error, 'error');
            button.disabled = false;
            button.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to redeem reward. Please try again.', 'error');
        button.disabled = false;
        button.textContent = originalText;
    });
}

function updateAllButtonStates() {
    const buttons = document.querySelectorAll('.redeem-button');
    buttons.forEach(button => {
        const card = button.closest('.reward-card');
        const costText = card.querySelector('.reward-cost span:last-child').textContent;
        const cost = parseInt(costText.match(/\d+/)[0]);
        const stockText = card.querySelector('.reward-stock').textContent;
        const stock = parseInt(stockText.match(/\d+/)[0]);
        
        if (stock === 0) {
            button.textContent = 'Out of Stock';
            button.disabled = true;
            button.className = 'redeem-button';
        } else if (currentPoints < cost) {
            button.textContent = `Need ${cost - currentPoints} more points`;
            button.disabled = true;
            button.className = 'redeem-button insufficient-points';
        } else {
            button.textContent = 'Redeem';
            button.disabled = false;
            button.className = 'redeem-button';
        }
    });
}

let currentRewardId = null;
let currentRewardName = null;
let currentRewardCost = null;
let userLatitude = null;
let userLongitude = null;
let claimMap = null;
let autocomplete = null;
let geocoder = null;
let mapMarker = null;

function openClaimModal(rewardId, rewardName, cost) {
    currentRewardId = rewardId;
    currentRewardName = rewardName;
    currentRewardCost = cost;
    
    document.getElementById('modalTitle').textContent = 'Claim ' + rewardName;
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('collectionDate').min = today;
    document.getElementById('collectionDate').value = today;
    
    // Clear form
    document.getElementById('customerAddress').value = '';
    userLatitude = null;
    userLongitude = null;
    
    // Show modal
    document.getElementById('claimModal').style.display = 'flex';
    
    // Initialize Google Maps features after modal is shown
    setTimeout(() => {
        initializeGoogleMaps();
    }, 100);
}

function closeClaimModal() {
    document.getElementById('claimModal').style.display = 'none';
    userLatitude = null;
    userLongitude = null;
    if (claimMap) {
        claimMap = null;
    }
    if (autocomplete) {
        autocomplete = null;
    }
}

function initializeGoogleMaps() {
    // Check if Google Maps API is loaded
    if (typeof google === 'undefined' || !google.maps) {
        console.log('Google Maps API not loaded, using fallback functionality');
        initializeFallbackMap();
        return;
    }
    
    try {
        // Initialize map centered on Singapore
        const singaporeCenter = { lat: 1.3521, lng: 103.8198 };
        
        claimMap = new google.maps.Map(document.getElementById('claimMap'), {
            center: singaporeCenter,
            zoom: 11,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });
        
        // Initialize geocoder
        geocoder = new google.maps.Geocoder();
        
        // Initialize autocomplete
        const addressInput = document.getElementById('customerAddress');
        autocomplete = new google.maps.places.Autocomplete(addressInput, {
            componentRestrictions: { country: 'sg' }, // Restrict to Singapore
            fields: ['formatted_address', 'geometry', 'name'],
            types: ['establishment', 'geocode']
        });
        
        // Listen for place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place.geometry) {
                showNotification('Please select a valid address from the suggestions', 'warning');
                return;
            }
            
            // Update coordinates
            userLatitude = place.geometry.location.lat();
            userLongitude = place.geometry.location.lng();
            
            // Update map
            updateMapLocation(userLatitude, userLongitude, place.formatted_address);
        });
        
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        initializeFallbackMap();
    }
}

function initializeFallbackMap() {
    // Fallback map display when Google Maps is not available
    document.getElementById('claimMap').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 8px; color: #6b7280;">
            <div style="text-align: center;">
                üìç Collection Point Preview<br>
                <small>Enter your address above<br>Nearest polytechnic will be shown here</small>
            </div>
        </div>
    `;
}

function updateMapLocation(lat, lng, address) {
    if (!claimMap) return;
    
    const location = { lat: lat, lng: lng };
    
    // Remove existing marker
    if (mapMarker) {
        mapMarker.setMap(null);
    }
    
    // Add new marker
    mapMarker = new google.maps.Marker({
        position: location,
        map: claimMap,
        title: address || 'Your Location',
        animation: google.maps.Animation.DROP
    });
    
    // Center map on location
    claimMap.setCenter(location);
    claimMap.setZoom(15);
}

// Close modal when clicking outside
document.getElementById('claimModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeClaimModal();
    }
});

document.getElementById('useCurrentLocation').addEventListener('click', function() {
    if (navigator.geolocation) {
        const button = this;
        button.textContent = 'üìç Getting location...';
        button.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLatitude = position.coords.latitude;
                userLongitude = position.coords.longitude;
                
                // Update map location
                updateMapLocation(userLatitude, userLongitude, 'Your Current Location');
                
                // Reverse geocode to get clean address
                reverseGeocode(userLatitude, userLongitude);
                
                button.textContent = 'üìç Location detected';
                button.disabled = false;
            },
            function(error) {
                let errorMessage = 'Unable to get your location';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location access denied. Please allow location access and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out.';
                        break;
                }
                showNotification(errorMessage, 'error');
                button.textContent = 'üìç Use Current Location';
                button.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    } else {
        showNotification('Geolocation is not supported by this browser', 'error');
    }
});


function reverseGeocode(lat, lng) {
    const addressField = document.getElementById('customerAddress');
    
    if (geocoder && typeof google !== 'undefined') {
        // Use Google Geocoding API for clean addresses
        const location = { lat: lat, lng: lng };
        
        geocoder.geocode({ location: location }, function(results, status) {
            if (status === 'OK' && results[0]) {
                // Get the most appropriate address
                let cleanAddress = results[0].formatted_address;
                
                // Try to find a more specific address (without country if it's Singapore)
                for (let result of results) {
                    if (result.types.includes('street_address') || 
                        result.types.includes('premise') ||
                        result.types.includes('establishment')) {
                        cleanAddress = result.formatted_address;
                        break;
                    }
                }
                
                // Remove ", Singapore" if present to make it cleaner
                cleanAddress = cleanAddress.replace(', Singapore', '');
                
                addressField.value = cleanAddress;
                
                // Trigger autocomplete place_changed if available
                if (autocomplete) {
                    google.maps.event.trigger(addressField, 'focus');
                    google.maps.event.trigger(addressField, 'keydown', {keyCode: 13});
                }
            } else {
                // Fallback if geocoding fails
                addressField.value = `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                showNotification('Could not determine address. Please enter your address manually.', 'warning');
            }
        });
    } else {
        // Fallback when Google Maps is not available
        addressField.value = `Near coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        showNotification('Please enter your complete address manually for accurate carpark assignment.', 'warning');
    }
}

document.getElementById('claimForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const collectionDate = document.getElementById('collectionDate').value;
    const address = document.getElementById('customerAddress').value;
    
    if (!collectionDate || !address || address.trim().length < 5) {
        showNotification('Please fill in all required fields with valid information', 'error');
        return;
    }
    
    const submitBtn = document.getElementById('submitClaim');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    
    const requestData = {
        reward_id: currentRewardId,
        collection_date: collectionDate,
        address: address
    };
    
    // Add coordinates if available
    if (userLatitude && userLongitude) {
        requestData.latitude = userLatitude;
        requestData.longitude = userLongitude;
    }
    
    fetch('/rewards/claim', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Update points display
            currentPoints = data.remaining_points;
            document.getElementById('user-points').innerHTML = `
                <div class="points-icon">üíé</div>
                <span>You have <strong>${currentPoints}</strong> points</span>
            `;
            
            // Update stock display
            const buttons = document.querySelectorAll('.redeem-button');
            buttons.forEach(button => {
                const card = button.closest('.reward-card');
                const stockElement = card.querySelector('.reward-stock');
                if (stockElement && stockElement.textContent.includes('Stock:')) {
                    const rewardIdFromButton = button.getAttribute('onclick').match(/\d+/)[0];
                    if (rewardIdFromButton == currentRewardId) {
                        stockElement.textContent = `Stock: ${data.remaining_stock}`;
                    }
                }
            });
            
            // Update button states
            updateAllButtonStates();
            
            // Close modal
            closeClaimModal();
            
            // Redirect to confirmation page after a short delay
            setTimeout(() => {
                window.location.href = `/rewards/confirmation/${data.order_id}`;
            }, 2000);
            
        } else {
            showNotification(data.error, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to claim reward. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

// Refund order functionality
async function refundOrder(orderId, rewardName, pointsSpent) {
    // Show confirmation dialog
    const confirmMessage = `Are you sure you want to refund this order?\n\nReward: ${rewardName}\nPoints to be restored: ${pointsSpent}\n\nThis action will:\n‚Ä¢ Restore ${pointsSpent} points to your account\n‚Ä¢ Add 1 item back to stock\n‚Ä¢ Permanently delete this order\n\nThis cannot be undone!`;
    
    const confirmation = await customConfirm(confirmMessage, 'Refund Order');
    
    if (!confirmation) {
        return;
    }
    
    // Find and disable the refund button
    const refundButton = event.target;
    const originalText = refundButton.innerHTML;
    refundButton.disabled = true;
    refundButton.innerHTML = '‚è≥';
    
    fetch('/rewards/refund', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Update points display
            currentPoints = data.new_points_balance;
            document.getElementById('user-points').innerHTML = `
                <div class="points-icon">üíé</div>
                <span>You have <strong>${currentPoints}</strong> points</span>
            `;
            
            // Remove the order row from the table
            const orderRow = refundButton.closest('tr');
            if (orderRow) {
                orderRow.style.transition = 'opacity 0.3s ease';
                orderRow.style.opacity = '0';
                setTimeout(() => {
                    orderRow.remove();
                    
                    // Check if table is now empty
                    const tableBody = document.querySelector('#claimed-tab tbody');
                    if (tableBody && tableBody.children.length === 0) {
                        // Replace table with "no history" message
                        const tabContent = document.getElementById('claimed-tab');
                        tabContent.innerHTML = `
                            <div class="no-history">
                                <div class="no-history-icon">üéÅ</div>
                                <h3>No Claimed Rewards Yet</h3>
                                <p>When you claim rewards, they'll appear here with collection details and locations.</p>
                            </div>
                        `;
                    }
                }, 300);
            }
            
            // Update button states for reward cards
            updateAllButtonStates();
            
        } else {
            showNotification(data.error, 'error');
            refundButton.disabled = false;
            refundButton.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to process refund. Please try again.', 'error');
        refundButton.disabled = false;
        refundButton.innerHTML = originalText;
    });
}

// History tab switching functionality
function showHistoryTab(tabName) {
    // Hide all tabs
    const tabs = document.querySelectorAll('.history-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Remove active class from all buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => button.classList.remove('active'));
    
    // Show selected tab
    const selectedTab = document.getElementById(tabName + '-tab');
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Activate selected button
    const selectedButton = event.target;
    if (selectedButton) {
        selectedButton.classList.add('active');
    }
}
</script>
{% endblock %}